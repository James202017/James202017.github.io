# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –±–æ—Ç–æ–≤
param(
    [switch]$Stop,
    [switch]$Status
)

$bots = @("BOT_P", "BOT_PR", "BOT_Inv", "BOT_Str", "BOT_Ocenka")

if ($Stop) {
    Write-Host "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –±–æ—Ç–æ–≤..." -ForegroundColor Yellow
    Get-Process python -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like "*bots/BOT_*" } | Stop-Process -Force
    Write-Host "–í—Å–µ –±–æ—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã" -ForegroundColor Green
    exit
}

if ($Status) {
    Write-Host "–°—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤:" -ForegroundColor Cyan
    $processes = Get-Process python -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like "*bots/BOT_*" }
    if ($processes) {
        $processes | ForEach-Object {
            $botName = (($_.CommandLine -split "bots/")[1] -split "\.py")[0]
            Write-Host "‚úì $botName –∑–∞–ø—É—â–µ–Ω (PID: $($_.Id))" -ForegroundColor Green
        }
    } else {
        Write-Host "–ë–æ—Ç—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã" -ForegroundColor Red
    }
    exit
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
if (-not (Test-Path ".env")) {
    Write-Host "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!" -ForegroundColor Red
    Write-Host "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.example" -ForegroundColor Yellow
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
$envContent = Get-Content ".env"
$missingTokens = @()

foreach ($bot in $bots) {
    $tokenVar = "BOT_TOKEN_" + ($bot -replace "BOT_", "")
    if (-not ($envContent | Select-String "$tokenVar=")) {
        $missingTokens += $tokenVar
    }
}

if ($missingTokens.Count -gt 0) {
    Write-Host "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–æ–∫–µ–Ω—ã:" -ForegroundColor Red
    $missingTokens | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
    exit 1
}

Write-Host "üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –±–æ—Ç–æ–≤..." -ForegroundColor Green

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
if (-not (Test-Path "logs")) {
    New-Item -ItemType Directory -Path "logs" | Out-Null
}

# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
foreach ($bot in $bots) {
    $logFile = "logs/$bot.log"
    Write-Host "–ó–∞–ø—É—Å–∫ $bot..." -ForegroundColor Cyan
    
    # –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
    Start-Process -FilePath "python" -ArgumentList "bots/$bot.py" -RedirectStandardOutput $logFile -RedirectStandardError "$logFile.error" -WindowStyle Hidden
    
    Start-Sleep -Seconds 1
}

Write-Host "`n‚úÖ –í—Å–µ –±–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!" -ForegroundColor Green
Write-Host "`n–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:" -ForegroundColor Yellow
Write-Host "  .\start-all-bots.ps1 -Status    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å" -ForegroundColor Gray
Write-Host "  .\start-all-bots.ps1 -Stop      # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –±–æ—Ç—ã" -ForegroundColor Gray
Write-Host "  Get-Content logs\BOT_P.log -Tail 10  # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤" -ForegroundColor Gray

Write-Host "`n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –±–æ—Ç–æ–≤ –≤ Telegram!" -ForegroundColor Cyan