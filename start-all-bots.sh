#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –≤ GitHub Codespaces

BOTS=("BOT_P" "BOT_PR" "BOT_Inv" "BOT_Str" "BOT_Ocenka")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–æ–≤
stop_bots() {
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –±–æ—Ç–æ–≤..."
    
    if command -v powershell.exe >/dev/null 2>&1; then
        # Windows –æ–∫—Ä—É–∂–µ–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º WMI –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        powershell.exe -Command "Get-WmiObject Win32_Process | Where-Object { \\\$_.Name -eq 'python.exe' -and \\\$_.CommandLine -like '*bots/*' } | ForEach-Object { Stop-Process -Id \\\$_.ProcessId -Force }" 2>/dev/null
    else
        # Linux –æ–∫—Ä—É–∂–µ–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º pkill
        pkill -f "python.*bots/"
    fi
    
    echo "‚úÖ –í—Å–µ –±–æ—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
check_status() {
    echo "üìä –°—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤:"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã —á–µ—Ä–µ–∑ PowerShell (–¥–ª—è Windows)
    if command -v powershell.exe >/dev/null 2>&1; then
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Get-Process –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Windows
        for bot in "${BOTS[@]}"; do
            result=$(powershell.exe -Command "Get-Process python -ErrorAction SilentlyContinue | Where-Object { (Get-WmiObject Win32_Process -Filter \"ProcessId = \\\$(\\\$_.Id)\").CommandLine -like '*bots/$bot.py*' } | Select-Object -First 1 -ExpandProperty Id" 2>/dev/null | tr -d '\r\n' | sed 's/[[:space:]]*$//')
            if [ ! -z "$result" ] && [ "$result" != "" ]; then
                echo "‚úÖ $bot –∑–∞–ø—É—â–µ–Ω (PID: $result)"
            else
                echo "‚ùå $bot –Ω–µ –∑–∞–ø—É—â–µ–Ω"
            fi
        done
    else
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Linux
        for bot in "${BOTS[@]}"; do
            if pgrep -f "python.*bots/$bot.py" > /dev/null; then
                pid=$(pgrep -f "python.*bots/$bot.py")
                echo "‚úÖ $bot –∑–∞–ø—É—â–µ–Ω (PID: $pid)"
            else
                echo "‚ùå $bot –Ω–µ –∑–∞–ø—É—â–µ–Ω"
            fi
        done
    fi
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
case "$1" in
    "stop")
        stop_bots
        exit 0
        ;;
    "status")
        check_status
        exit 0
        ;;
    "restart")
        stop_bots
        sleep 2
        ;;
esac

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.example:"
    echo "   cp .env.example .env"
    echo "   nano .env  # –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ —Ç–æ–∫–µ–Ω—ã"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤..."
missing_tokens=()

for bot in "${BOTS[@]}"; do
    token_var="BOT_TOKEN_${bot#BOT_}"
    if ! grep -q "^$token_var=" .env; then
        missing_tokens+=("$token_var")
    fi
done

if [ ${#missing_tokens[@]} -gt 0 ]; then
    echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–æ–∫–µ–Ω—ã:"
    for token in "${missing_tokens[@]}"; do
        echo "   - $token"
    done
    echo "üí° –î–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–æ–∫–µ–Ω—ã –≤ —Ñ–∞–π–ª .env"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if ! python3 -c "import aiogram" 2>/dev/null; then
    echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    pip install -r requirements.txt
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p logs

echo "üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –±–æ—Ç–æ–≤..."

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
stop_bots
sleep 1

# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
for bot in "${BOTS[@]}"; do
    echo "üîÑ –ó–∞–ø—É—Å–∫ $bot..."
    nohup python3 "bots/$bot.py" > "logs/$bot.log" 2>&1 &
    sleep 0.5
done

echo ""
echo "‚úÖ –í—Å–µ –±–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   ./start-all-bots.sh status    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
echo "   ./start-all-bots.sh stop      # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –±–æ—Ç—ã"
echo "   ./start-all-bots.sh restart   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –±–æ—Ç—ã"
echo "   tail -f logs/BOT_P.log        # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo ""
echo "üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –±–æ—Ç–æ–≤ –≤ Telegram!"
echo ""

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
sleep 3
check_status